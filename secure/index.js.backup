import express from 'express';
import session from 'express-session';
import multer from 'multer';
import bcrypt from 'bcryptjs';
import path from 'path';
import { fileURLToPath } from 'url';
import crypto from 'crypto';
import fs from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();

// Secure file upload configuration
const ALLOWED_EXTENSIONS = ['.png', '.jpg', '.jpeg', '.gif'];
const ALLOWED_MIME = ['image/png', 'image/jpeg', 'image/gif'];
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadPath = path.join(__dirname, 'uploads');
    if (!fs.existsSync(uploadPath)) {
      fs.mkdirSync(uploadPath, { recursive: true });
    }
    cb(null, uploadPath);
  },
  filename: (req, file, cb) => {
    // Generate secure random filename
    const uniqueName = crypto.randomBytes(16).toString('hex');
    const ext = path.extname(file.originalname).toLowerCase();
    cb(null, `${uniqueName}${ext}`);
  }
});

const fileFilter = (req, file, cb) => {
  const ext = path.extname(file.originalname).toLowerCase();
  const mime = file.mimetype;
  
  if (!ALLOWED_EXTENSIONS.includes(ext)) {
    return cb(new Error('Invalid file extension'), false);
  }
  
  if (!ALLOWED_MIME.includes(mime)) {
    return cb(new Error('Invalid MIME type'), false);
  }
  
  cb(null, true);
};

const upload = multer({ 
  storage,
  fileFilter,
  limits: { fileSize: MAX_FILE_SIZE }
});

app.use(express.urlencoded({ extended: true }));
app.use(session({ 
  secret: crypto.randomBytes(32).toString('hex'), // Secure random secret
  resave: false, 
  saveUninitialized: false,
  cookie: { 
    secure: false, // Set to true in production with HTTPS
    httpOnly: true,
    maxAge: 1000 * 60 * 60 * 24 // 24 hours
  }
}));
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// CSRF Token middleware
app.use((req, res, next) => {
  if (!req.session.csrfToken) {
    req.session.csrfToken = crypto.randomBytes(32).toString('hex');
  }
  next();
});

// Dummy user DB (pre-hashed passwords)
const users = [
  { username: 'alice', password: bcrypt.hashSync('alice123', 10) },
  { username: 'bob', password: bcrypt.hashSync('bob123', 10) }
];

function findUser(username) {
  return users.find(u => u.username === username);
}

// Password strength validator
function isPasswordStrong(password) {
  if (password.length < 8) return { valid: false, message: 'Password must be at least 8 characters' };
  if (!/[A-Z]/.test(password)) return { valid: false, message: 'Password must contain uppercase letter' };
  if (!/[a-z]/.test(password)) return { valid: false, message: 'Password must contain lowercase letter' };
  if (!/[0-9]/.test(password)) return { valid: false, message: 'Password must contain number' };
  return { valid: true };
}

// HTML Template with better UI
const pageTemplate = (title, content, showNav = false, username = '', csrfToken = '') => `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title} - Kemjar ProyekAkhir_15 (SECURE)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .navbar {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .main-container {
      max-width: 900px;
      margin: 50px auto;
      padding: 0 20px;
    }
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      background: white;
      overflow: hidden;
    }
    .card-header {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 25px;
      border: none;
    }
    .card-body {
      padding: 30px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      transition: transform 0.2s;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
    }
    .btn-success {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
    }
    .btn-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      color: white;
    }
    .btn-danger {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
    }
    .form-control {
      border-radius: 8px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      transition: border-color 0.3s;
    }
    .form-control:focus {
      border-color: #11998e;
      box-shadow: 0 0 0 0.2rem rgba(17, 153, 142, 0.25);
    }
    .badge-secure {
      background: #28a745;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .welcome-icon {
      font-size: 4rem;
      color: #11998e;
      margin-bottom: 20px;
    }
    .feature-card {
      transition: transform 0.3s;
      cursor: pointer;
    }
    .feature-card:hover {
      transform: translateY(-5px);
    }
    .password-strength {
      height: 5px;
      border-radius: 5px;
      margin-top: 5px;
      transition: all 0.3s;
    }
  </style>
</head>
<body>
  ${showNav ? `
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">
        <i class="fas fa-shield-alt text-success me-2"></i>
        Kemjar ProyekAkhir_15
        <span class="badge badge-secure ms-2">✓ SECURE</span>
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3">
          <i class="fas fa-user-circle me-2"></i>${username}
        </span>
        <a class="btn btn-sm btn-outline-danger" href="/logout">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </a>
      </div>
    </div>
  </nav>
  ` : ''}
  
  <div class="main-container">
    ${content}
  </div>
  
  <script>
    // Password strength meter
    function checkPasswordStrength(password) {
      let strength = 0;
      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[a-z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;
      
      const meter = document.getElementById('password-strength');
      if (!meter) return;
      
      const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997'];
      const widths = [20, 40, 60, 80, 100];
      
      meter.style.width = widths[strength - 1] + '%';
      meter.style.backgroundColor = colors[strength - 1];
    }
  </script>
</body>
</html>
`;

app.get('/', (req, res) => {
  if (!req.session.user) {
    const content = `
      <div class="card text-center">
        <div class="card-header">
          <h2 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Welcome to Kemjar ProyekAkhir_15</h2>
        </div>
        <div class="card-body">
          <div class="welcome-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h4 class="mb-4">Secure Web Application Demo</h4>
          <span class="badge badge-secure mb-4">✓ SECURE VERSION - All Vulnerabilities Fixed</span>
          <p class="text-muted mb-4">This application demonstrates secure coding practices and vulnerability remediation.</p>
          <a class="btn btn-primary btn-lg" href="/login">
            <i class="fas fa-sign-in-alt me-2"></i>Login to Continue
          </a>
        </div>
      </div>
    `;
    return res.send(pageTemplate('Home', content));
  }

  const content = `
    <div class="card">
      <div class="card-header">
        <h3 class="mb-0"><i class="fas fa-home me-2"></i>Dashboard</h3>
      </div>
      <div class="card-body">
        <div class="alert alert-success mb-4">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Secure:</strong> This version implements proper security controls for all features.
        </div>
        
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card feature-card h-100" onclick="location.href='/upload'">
              <div class="card-body text-center">
                <i class="fas fa-upload text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Upload File</h5>
                <p class="text-muted small">Secure file upload with validation</p>
                <span class="badge bg-success">✓ Secure File Upload</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card feature-card h-100" onclick="location.href='/change-password'">
              <div class="card-body text-center">
                <i class="fas fa-key text-warning" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Change Password</h5>
                <p class="text-muted small">Secure password change with validation</p>
                <span class="badge bg-success">✓ Secure Password Change</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  res.send(pageTemplate('Dashboard', content, true, req.session.user));
});

app.get('/login', (req, res) => {
  const content = `
    <div class="card">
      <div class="card-header">
        <h3 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i>Login</h3>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-4">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Test Credentials:</strong><br>
          Username: <code>alice</code> / Password: <code>alice123</code><br>
          Username: <code>bob</code> / Password: <code>bob123</code>
        </div>
        <form method="post">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-user me-2"></i>Username</label>
            <input class="form-control" name="username" placeholder="Enter username" required>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-lock me-2"></i>Password</label>
            <input class="form-control" name="password" type="password" placeholder="Enter password" required>
          </div>
          <input type="hidden" name="csrf_token" value="${req.session.csrfToken}">
          <button class="btn btn-primary w-100">
            <i class="fas fa-sign-in-alt me-2"></i>Login
          </button>
        </form>
      </div>
    </div>
  `;
  res.send(pageTemplate('Login', content, false, '', req.session.csrfToken));
});

app.post('/login', (req, res) => {
  const { username, password, csrf_token } = req.body;
  
  // CSRF protection
  if (csrf_token !== req.session.csrfToken) {
    const content = `
      <div class="card">
        <div class="card-body text-center">
          <i class="fas fa-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
          <h4 class="mt-3">CSRF Token Invalid</h4>
          <p class="text-muted">Security token mismatch detected</p>
          <a href="/login" class="btn btn-primary">Back to Login</a>
        </div>
      </div>
    `;
    return res.send(pageTemplate('CSRF Error', content));
  }
  
  const user = findUser(username);
  if (user && bcrypt.compareSync(password, user.password)) {
    req.session.user = username;
    // Regenerate session ID to prevent session fixation
    req.session.regenerate((err) => {
      if (err) {
        console.error('Session regeneration error:', err);
      }
      req.session.user = username;
      req.session.csrfToken = crypto.randomBytes(32).toString('hex');
      res.redirect('/');
    });
  } else {
    const content = `
      <div class="card">
        <div class="card-body text-center">
          <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
          <h4 class="mt-3">Login Failed</h4>
          <p class="text-muted">Invalid username or password</p>
          <a href="/login" class="btn btn-primary">
            <i class="fas fa-redo me-2"></i>Try Again
          </a>
        </div>
      </div>
    `;
    res.send(pageTemplate('Login Failed', content));
  }
});

app.get('/logout', (req, res) => {
  req.session.destroy(() => res.redirect('/'));
});

// SECURE: Proper file upload with validation
app.get('/upload', (req, res) => {
  if (!req.session.user) return res.redirect('/login');
  
  const content = `
    <div class="card">
      <div class="card-header">
        <h3 class="mb-0"><i class="fas fa-upload me-2"></i>Upload File</h3>
      </div>
      <div class="card-body">
        <div class="alert alert-success mb-4">
          <i class="fas fa-shield-alt me-2"></i>
          <strong>Security Features:</strong>
          <ul class="mb-0 mt-2">
            <li>File extension validation (${ALLOWED_EXTENSIONS.join(', ')})</li>
            <li>MIME type verification</li>
            <li>File size limit (${MAX_FILE_SIZE / 1024 / 1024}MB max)</li>
            <li>Randomized secure filenames</li>
            <li>CSRF protection</li>
          </ul>
        </div>
        
        <form method="post" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-file me-2"></i>Choose File</label>
            <input class="form-control" type="file" name="file" accept=".png,.jpg,.jpeg,.gif" required>
            <div class="form-text">Only image files (PNG, JPG, JPEG, GIF) up to 5MB</div>
          </div>
          <input type="hidden" name="csrf_token" value="${req.session.csrfToken}">
          <button class="btn btn-success w-100">
            <i class="fas fa-cloud-upload-alt me-2"></i>Upload
          </button>
        </form>
        
        <div class="mt-3">
          <a href="/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  `;
  res.send(pageTemplate('Upload File', content, true, req.session.user));
});

app.post('/upload', (req, res, next) => {
  if (!req.session.user) return res.redirect('/login');
  
  // CSRF protection
  if (req.body.csrf_token !== req.session.csrfToken) {
    return res.status(403).send('CSRF token invalid');
  }
  
  upload.single('file')(req, res, (err) => {
    if (err) {
      const content = `
        <div class="card">
          <div class="card-body text-center">
            <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Upload Failed</h4>
            <div class="alert alert-danger mt-3">
              <strong>Error:</strong> ${err.message}
            </div>
            <p class="text-muted">Please ensure your file meets all requirements.</p>
            <a href="/upload" class="btn btn-primary">
              <i class="fas fa-redo me-2"></i>Try Again
            </a>
          </div>
        </div>
      `;
      return res.send(pageTemplate('Upload Error', content, true, req.session.user));
    }
    
    if (!req.file) {
      return res.status(400).send('No file uploaded');
    }
    
    const content = `
      <div class="card">
        <div class="card-body text-center">
          <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
          <h4 class="mt-3">File Uploaded Successfully!</h4>
          <div class="alert alert-success mt-4">
            <i class="fas fa-shield-alt me-2"></i>
            <strong>Secure Upload:</strong> File validated and stored securely!
          </div>
          <div class="card mt-3 p-3">
            <p class="mb-2"><strong>Original Filename:</strong> <code>${req.file.originalname}</code></p>
            <p class="mb-2"><strong>Stored As:</strong> <code>${req.file.filename}</code></p>
            <p class="mb-2"><strong>File Size:</strong> ${(req.file.size / 1024).toFixed(2)} KB</p>
            <p class="mb-2"><strong>MIME Type:</strong> <code>${req.file.mimetype}</code></p>
            <p class="mb-0">
              <a href="/uploads/${req.file.filename}" target="_blank" class="btn btn-sm btn-primary">
                <i class="fas fa-eye me-2"></i>View File
              </a>
            </p>
          </div>
          <div class="mt-4">
            <a href="/upload" class="btn btn-success me-2">
              <i class="fas fa-upload me-2"></i>Upload Another
            </a>
            <a href="/" class="btn btn-outline-secondary">
              <i class="fas fa-home me-2"></i>Back to Dashboard
            </a>
          </div>
        </div>
      </div>
    `;
    res.send(pageTemplate('Upload Success', content, true, req.session.user));
  });
});

// SECURE: Proper password change with old password verification
app.get('/change-password', (req, res) => {
  if (!req.session.user) return res.redirect('/login');
  
  const content = `
    <div class="card">
      <div class="card-header">
        <h3 class="mb-0"><i class="fas fa-key me-2"></i>Change Password</h3>
      </div>
      <div class="card-body">
        <div class="alert alert-success mb-4">
          <i class="fas fa-shield-alt me-2"></i>
          <strong>Security Features:</strong>
          <ul class="mb-0 mt-2">
            <li>Current password verification required</li>
            <li>Password strength validation (min 8 chars, uppercase, lowercase, number)</li>
            <li>Password confirmation check</li>
            <li>CSRF protection</li>
          </ul>
        </div>
        
        <form method="post">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-lock me-2"></i>Current Password</label>
            <input class="form-control" name="old_password" type="password" placeholder="Enter current password" required>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-key me-2"></i>New Password</label>
            <input class="form-control" name="new_password" type="password" placeholder="Enter new password" 
                   oninput="checkPasswordStrength(this.value)" required>
            <div class="password-strength" id="password-strength"></div>
            <div class="form-text">Min 8 chars with uppercase, lowercase, and number</div>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-check me-2"></i>Confirm New Password</label>
            <input class="form-control" name="confirm_password" type="password" placeholder="Confirm new password" required>
          </div>
          <input type="hidden" name="csrf_token" value="${req.session.csrfToken}">
          <button class="btn btn-warning w-100">
            <i class="fas fa-key me-2"></i>Change Password
          </button>
        </form>
        
        <div class="mt-3">
          <a href="/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  `;
  res.send(pageTemplate('Change Password', content, true, req.session.user));
});

app.post('/change-password', (req, res) => {
  if (!req.session.user) return res.redirect('/login');
  
  const { old_password, new_password, confirm_password, csrf_token } = req.body;
  const user = findUser(req.session.user);
  
  // CSRF protection
  if (csrf_token !== req.session.csrfToken) {
    const content = `
      <div class="card">
        <div class="card-body text-center">
          <i class="fas fa-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
          <h4 class="mt-3">CSRF Token Invalid</h4>
          <p class="text-muted">Security token mismatch detected</p>
          <a href="/change-password" class="btn btn-primary">Back</a>
        </div>
      </div>
    `;
    return res.send(pageTemplate('Error', content, true, req.session.user));
  }
  
  // Verify old password
  if (!bcrypt.compareSync(old_password, user.password)) {
    const content = `
      <div class="card">
        <div class="card-body text-center">
          <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
          <h4 class="mt-3">Current Password Incorrect</h4>
          <p class="text-muted">The current password you entered is incorrect</p>
          <a href="/change-password" class="btn btn-primary">
            <i class="fas fa-redo me-2"></i>Try Again
          </a>
        </div>
      </div>
    `;
    return res.send(pageTemplate('Password Error', content, true, req.session.user));
  }
  
  // Check password strength
  const strengthCheck = isPasswordStrong(new_password);
  if (!strengthCheck.valid) {
    const content = `
      <div class="card">
        <div class="card-body text-center">
          <i class="fas fa-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
          <h4 class="mt-3">Weak Password</h4>
          <div class="alert alert-warning mt-3">
            <strong>Error:</strong> ${strengthCheck.message}
          </div>
          <a href="/change-password" class="btn btn-primary">
            <i class="fas fa-redo me-2"></i>Try Again
          </a>
        </div>
      </div>
    `;
    return res.send(pageTemplate('Password Error', content, true, req.session.user));
  }
  
  // Verify password confirmation
  if (new_password !== confirm_password) {
    const content = `
      <div class="card">
        <div class="card-body text-center">
          <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
          <h4 class="mt-3">Passwords Don't Match</h4>
          <p class="text-muted">New password and confirmation don't match</p>
          <a href="/change-password" class="btn btn-primary">
            <i class="fas fa-redo me-2"></i>Try Again
          </a>
        </div>
      </div>
    `;
    return res.send(pageTemplate('Password Error', content, true, req.session.user));
  }
  
  // Update password
  user.password = bcrypt.hashSync(new_password, 10);
  
  const content = `
    <div class="card">
      <div class="card-body text-center">
        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
        <h4 class="mt-3">Password Changed Successfully!</h4>
        <div class="alert alert-success mt-4">
          <i class="fas fa-shield-alt me-2"></i>
          <strong>Secure:</strong> Password changed with proper validation and verification!
        </div>
        <p class="text-muted">Your password has been updated securely</p>
        <div class="mt-4">
          <a href="/" class="btn btn-primary">
            <i class="fas fa-home me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  `;
  res.send(pageTemplate('Password Changed', content, true, req.session.user));
});

const PORT = 3002;
app.listen(PORT, () => console.log(`✓ SECURE app running on http://localhost:${PORT}`));
